<!doctype html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LAIR — Калькулятор оренди</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg:#2d2d2d;
      --accent:#E05A47;
      --text:#F5F5F5;
    }
    html,body{height:100%;}
    body{background:var(--bg); color:var(--text);}
    /* premium scrollbar */
    ::-webkit-scrollbar{width:10px;}
    ::-webkit-scrollbar-track{background:rgba(255,255,255,.06);}
    ::-webkit-scrollbar-thumb{background:rgba(224,90,71,.55); border-radius:999px;}
    ::-webkit-scrollbar-thumb:hover{background:rgba(224,90,71,.75);}

    /* range slider */
    input[type="range"]{
      -webkit-appearance:none;
      appearance:none;
      width:100%;
      height:10px;
      border-radius:999px;
      background:linear-gradient(90deg, var(--accent) 0%, rgba(255,255,255,.12) 0%);
      outline:none;
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;
      appearance:none;
      width:20px;height:20px;border-radius:999px;
      background:var(--text);
      border:2px solid rgba(224,90,71,.9);
      box-shadow:0 6px 16px rgba(0,0,0,.35);
      cursor:pointer;
      transition:transform .15s ease;
    }
    input[type="range"]::-webkit-slider-thumb:hover{transform:scale(1.06);}
    input[type="range"]::-moz-range-thumb{
      width:20px;height:20px;border-radius:999px;
      background:var(--text);
      border:2px solid rgba(224,90,71,.9);
      box-shadow:0 6px 16px rgba(0,0,0,.35);
      cursor:pointer;
      transition:transform .15s ease;
    }

    .glass{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
    }
    .card{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 12px 28px rgba(0,0,0,.28);
      border-radius:20px;
    }
    .btn{
      border-radius:16px;
      transition:transform .12s ease, background .2s ease, border-color .2s ease, opacity .2s ease;
    }
    .btn:active{transform:translateY(1px) scale(.99);}
    .tab-active{
      background:rgba(224,90,71,.14);
      border-color:rgba(224,90,71,.55);
      color:var(--text);
    }
    .tab-inactive{
      background:rgba(255,255,255,.04);
      border-color:rgba(255,255,255,.10);
      color:rgba(245,245,245,.85);
    }
    .pill{
      border-radius:999px;
      padding:.35rem .65rem;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      color:rgba(245,245,245,.9);
      font-size:.85rem;
      line-height:1;
      white-space:nowrap;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .focus-ring:focus{
      outline:none;
      box-shadow:0 0 0 3px rgba(224,90,71,.35);
      border-color:rgba(224,90,71,.55);
    }
  </style>
</head>

<body class="min-h-screen">
  <!-- Top bar -->
  <header class="w-full">
    <div class="max-w-6xl mx-auto px-4 pt-6 pb-3">
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="w-11 h-11 rounded-2xl glass flex items-center justify-center">
            <span class="mono text-[13px] tracking-widest" style="color:var(--accent);">LAIR</span>
          </div>
          <div>
            <div class="text-xl font-semibold leading-tight">Калькулятор оренди</div>
            <div class="text-sm opacity-80">Збери конфіг → побач ціну → відправ заявку</div>
          </div>
        </div>

        <!-- Hidden / subtle admin entry -->
        <button id="openAdminBtn"
                class="text-xs opacity-55 hover:opacity-90 transition underline decoration-dotted underline-offset-4"
                title="Налаштування цін (для менеджера)">
          Налаштування цін
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-10">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
      <!-- Left: Tabs content -->
      <section class="lg:col-span-8 space-y-4">
        <!-- Tabs -->
        <div class="card p-3">
          <div class="grid grid-cols-3 gap-2">
            <button class="btn border px-3 py-3 text-sm font-medium tab-active" data-tab="equipment">
              1) Обладнання
            </button>
            <button class="btn border px-3 py-3 text-sm font-medium tab-inactive" data-tab="logistics">
              2) Логістика & сервіс
            </button>
            <button class="btn border px-3 py-3 text-sm font-medium tab-inactive" data-tab="contacts">
              3) Контакти
            </button>
          </div>
        </div>

        <!-- Tab panels -->
        <!-- Equipment -->
        <div id="tab-equipment" class="card p-5 space-y-5">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-lg font-semibold">Обладнання</div>
              <div class="text-sm opacity-80">Обирай кількість. Ціни — за добу.</div>
            </div>
            <span class="pill">Автокорекції: PS5 ↔ ТВ</span>
          </div>

          <!-- Slider blocks -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Laptops -->
            <div class="glass rounded-2xl p-4 border border-white/10">
              <div class="flex items-center justify-between">
                <div class="font-medium">Ігрові ноутбуки <span class="opacity-80">(RTX 5070)</span></div>
                <div class="pill"><span id="qtyLaptop">0</span> шт</div>
              </div>
              <div class="mt-3">
                <input id="laptop" type="range" min="0" max="20" step="1" value="0" />
                <div class="mt-2 text-xs opacity-70 flex justify-between">
                  <span>0</span><span>20</span>
                </div>
              </div>
            </div>

            <!-- PS5 -->
            <div class="glass rounded-2xl p-4 border border-white/10">
              <div class="flex items-center justify-between">
                <div class="font-medium">PlayStation 5</div>
                <div class="pill"><span id="qtyPS5">0</span> шт</div>
              </div>
              <div class="mt-3">
                <input id="ps5" type="range" min="0" max="10" step="1" value="0" />
                <div class="mt-2 text-xs opacity-70 flex justify-between">
                  <span>0</span><span>10</span>
                </div>
              </div>
              <div class="mt-2 text-xs opacity-70">
                ТВ автоматично не може бути менше, ніж PS5.
              </div>
            </div>

            <!-- VR -->
            <div class="glass rounded-2xl p-4 border border-white/10">
              <div class="flex items-center justify-between">
                <div class="font-medium">VR шоломи <span class="opacity-80">(Quest 3)</span></div>
                <div class="pill"><span id="qtyVR">0</span> шт</div>
              </div>
              <div class="mt-3">
                <input id="vr" type="range" min="0" max="10" step="1" value="0" />
                <div class="mt-2 text-xs opacity-70 flex justify-between">
                  <span>0</span><span>10</span>
                </div>
              </div>
            </div>

            <!-- TVs -->
            <div class="glass rounded-2xl p-4 border border-white/10">
              <div class="flex items-center justify-between">
                <div class="font-medium">ТВ 50–55" + стійка</div>
                <div class="pill"><span id="qtyTV">0</span> шт</div>
              </div>
              <div class="mt-3">
                <input id="tv" type="range" min="0" max="10" step="1" value="0" />
                <div class="mt-2 text-xs opacity-70 flex justify-between">
                  <span>0</span><span>10</span>
                </div>
              </div>
              <div class="mt-2 text-xs opacity-70">
                Якщо PS5 &gt; ТВ — ми піднімемо ТВ до рівня PS5.
              </div>
            </div>
          </div>

          <!-- Days -->
          <div class="glass rounded-2xl p-4 border border-white/10">
            <div class="flex items-center justify-between">
              <div class="font-medium">Тривалість оренди</div>
              <div class="pill"><span id="qtyDays">1</span> доба</div>
            </div>
            <div class="mt-3">
              <input id="days" type="range" min="1" max="7" step="1" value="1" />
              <div class="mt-2 text-xs opacity-70 flex justify-between">
                <span>1</span><span>7</span>
              </div>
            </div>
          </div>

          <div class="flex flex-wrap gap-2 pt-1">
            <span class="pill">Преміальна подача</span>
            <span class="pill">Сучасний dark UI</span>
            <span class="pill">Живий кошторис справа</span>
          </div>

          <div class="flex justify-end">
            <button id="toLogistics"
                    class="btn px-4 py-3 border border-white/10 bg-white/5 hover:bg-white/10">
              Далі → Логістика
            </button>
          </div>
        </div>

        <!-- Logistics -->
        <div id="tab-logistics" class="card p-5 space-y-5 hidden">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-lg font-semibold">Логістика та сервіс</div>
              <div class="text-sm opacity-80">Доставка + (за потреби) технічний адміністратор.</div>
            </div>
            <span class="pill">Адмін мін. 4 години</span>
          </div>

          <!-- Delivery select -->
          <div class="glass rounded-2xl p-4 border border-white/10">
            <label class="block text-sm font-medium mb-2">Зона доставки</label>
            <select id="delivery" class="w-full focus-ring rounded-2xl px-4 py-3 bg-white/5 border border-white/10">
              <option value="irpin_bucha">Ірпінь / Буча — 1000 грн</option>
              <option value="kyiv">Київ — 1500 грн</option>
              <option value="out_30">За містом (до 30км) — 2500 грн</option>
            </select>
            <div class="mt-2 text-xs opacity-70">Ціна доставки додається один раз до замовлення.</div>
          </div>

          <!-- Admin toggle + hours -->
          <div class="glass rounded-2xl p-4 border border-white/10">
            <div class="flex items-center justify-between gap-3">
              <div>
                <div class="font-medium">Технічний адміністратор</div>
                <div class="text-xs opacity-70">Оплата погодинно. Якщо увімкнено — мінімум 4 години.</div>
              </div>

              <label class="inline-flex items-center gap-2 cursor-pointer select-none">
                <span class="text-sm opacity-85">Додати</span>
                <input id="adminEnabled" type="checkbox" class="h-5 w-5 accent-[var(--accent)]" />
              </label>
            </div>

            <div id="adminHoursBlock" class="mt-4 hidden">
              <div class="flex items-center justify-between">
                <div class="text-sm font-medium">Години роботи адміністратора</div>
                <div class="pill"><span id="qtyAdminHours">4</span> год</div>
              </div>
              <div class="mt-3">
                <input id="adminHours" type="range" min="1" max="12" step="1" value="4" />
                <div class="mt-2 text-xs opacity-70 flex justify-between">
                  <span>1</span><span>12</span>
                </div>
              </div>
              <div class="mt-2 text-xs opacity-70">
                Якщо вибереш менше 4 — автоматично стане 4.
              </div>
            </div>
          </div>

          <div class="flex items-center justify-between gap-3">
            <button id="backToEquipment"
                    class="btn px-4 py-3 border border-white/10 bg-white/5 hover:bg-white/10">
              ← Назад
            </button>
            <button id="toContacts"
                    class="btn px-4 py-3 border border-white/10 bg-white/5 hover:bg-white/10">
              Далі → Контакти
            </button>
          </div>
        </div>

        <!-- Contacts -->
        <div id="tab-contacts" class="card p-5 space-y-5 hidden">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-lg font-semibold">Контакти</div>
              <div class="text-sm opacity-80">Заповни форму — і ми підтвердимо деталі та фінальну ціну.</div>
            </div>
            <span class="pill">Поля * обовʼязкові</span>
          </div>

          <form id="orderForm" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-2">Імʼя *</label>
                <input id="name" type="text" class="w-full focus-ring rounded-2xl px-4 py-3 bg-white/5 border border-white/10"
                       placeholder="Напр. Микита" required />
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">Телефон *</label>
                <input id="phone" type="tel" class="w-full focus-ring rounded-2xl px-4 py-3 bg-white/5 border border-white/10"
                       placeholder="+380..." required />
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">Дата івенту *</label>
                <input id="eventDate" type="date" class="w-full focus-ring rounded-2xl px-4 py-3 bg-white/5 border border-white/10"
                       required />
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">Локація</label>
                <input id="location" type="text" class="w-full focus-ring rounded-2xl px-4 py-3 bg-white/5 border border-white/10"
                       placeholder="Адреса / назва закладу" />
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium mb-2">Коментар</label>
              <textarea id="comment" rows="4" class="w-full focus-ring rounded-2xl px-4 py-3 bg-white/5 border border-white/10"
                        placeholder="Коротко: формат івенту, час початку, побажання по сетапу..."></textarea>
            </div>

            <div class="flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between pt-1">
              <button type="button" id="copyEstimate"
                      class="btn px-4 py-3 border border-white/10 bg-white/5 hover:bg-white/10">
                Копіювати кошторис
              </button>

              <div class="flex items-center gap-3">
                <button type="button" id="backToLogistics"
                        class="btn px-4 py-3 border border-white/10 bg-white/5 hover:bg-white/10">
                  ← Назад
                </button>
                <button type="submit" id="submitOrder"
                        class="btn px-5 py-3 border border-[rgba(224,90,71,.55)] bg-[rgba(224,90,71,.16)] hover:bg-[rgba(224,90,71,.24)]">
                  Замовити
                </button>
              </div>
            </div>

            <div id="formMsg" class="hidden text-sm rounded-2xl px-4 py-3 border"></div>
          </form>
        </div>
      </section>

      <!-- Right: Sticky estimate -->
      <aside class="lg:col-span-4">
        <div class="sticky top-4 space-y-4">
          <div class="card p-5">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-lg font-semibold">Кошторис</div>
                <div class="text-sm opacity-80">Орієнтовно (без знижок).</div>
              </div>
              <span class="pill mono" id="badgeDays">× 1d</span>
            </div>

            <div class="mt-4 space-y-3 text-sm">
              <div class="flex items-center justify-between">
                <span class="opacity-85">Ноутбуки</span>
                <span class="mono" id="sumLaptop">0</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="opacity-85">PS5</span>
                <span class="mono" id="sumPS5">0</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="opacity-85">VR</span>
                <span class="mono" id="sumVR">0</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="opacity-85">ТВ + стійки</span>
                <span class="mono" id="sumTV">0</span>
              </div>

              <div class="h-px bg-white/10 my-2"></div>

              <div class="flex items-center justify-between">
                <span class="opacity-85">Доставка</span>
                <span class="mono" id="sumDelivery">0</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="opacity-85">Адміністратор</span>
                <span class="mono" id="sumAdmin">0</span>
              </div>

              <div class="h-px bg-white/10 my-2"></div>

              <div class="flex items-center justify-between text-base">
                <span class="font-semibold">Разом</span>
                <span class="mono font-semibold" id="sumTotal" style="color:var(--accent);">0</span>
              </div>

              <div class="text-xs opacity-70 pt-2">
                * Лояльність/знижка на сайті прихована (0%). Фінальна ціна може уточнюватися менеджером.
              </div>
            </div>

            <div class="mt-4 flex flex-wrap gap-2">
              <span class="pill" id="pillAutoTV">TV ≥ PS5: OK</span>
              <span class="pill" id="pillAdminMin">Адмін: —</span>
              <span class="pill" id="pillDelivery">Доставка: —</span>
            </div>
          </div>

          <div class="card p-5">
            <div class="text-sm opacity-80 mb-2">Деталі (для копіювання)</div>
            <pre id="estimateText" class="mono text-xs whitespace-pre-wrap bg-white/5 border border-white/10 rounded-2xl p-4 max-h-56 overflow-auto"></pre>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Admin panel modal -->
  <div id="adminModal" class="fixed inset-0 hidden items-center justify-center p-4 z-50">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative w-full max-w-2xl card p-5">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-lg font-semibold">Налаштування цін</div>
          <div class="text-sm opacity-80">Менеджер може змінювати ціни без редагування коду (зберігається у браузері).</div>
        </div>
        <button id="closeAdminBtn" class="btn px-3 py-2 border border-white/10 bg-white/5 hover:bg-white/10">✕</button>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
        <div class="glass rounded-2xl p-4 border border-white/10">
          <label class="block font-medium mb-2">Ноутбук / доба (грн)</label>
          <input id="priceLaptop" type="number" min="0" class="w-full focus-ring rounded-2xl px-4 py-3 bg-white/5 border border-white/10" />
        </div>
        <div class="glass rounded-2xl p-4 border border-white/10">
          <label class="block font-medium mb-2">PS5 / доба (грн)</label>
          <input id="pricePS5" type="number" min="0" class="w-full focus-ring rounded-2xl px-4 py-3 bg-white/5 border border-white/10" />
        </div>
        <div class="glass rounded-2xl p-4 border border-white/10">
          <label class="block font-medium mb-2">VR / доба (грн)</label>
          <input id="priceVR" type="number" min="0" class="w-full focus-ring rounded-2xl px-4 py-3 bg-white/5 border border-white/10" />
        </div>
        <div class="glass rounded-2xl p-4 border border-white/10">
          <label class="block font-medium mb-2">ТВ+стійка / доба (грн)</label>
          <input id="priceTV" type="number" min="0" class="w-full focus-ring rounded-2xl px-4 py-3 bg-white/5 border border-white/10" />
        </div>
        <div class="glass rounded-2xl p-4 border border-white/10 md:col-span-2">
          <label class="block font-medium mb-2">Адміністратор / година (грн)</label>
          <input id="priceAdmin" type="number" min="0" class="w-full focus-ring rounded-2xl px-4 py-3 bg-white/5 border border-white/10" />
        </div>
        <div class="glass rounded-2xl p-4 border border-white/10">
          <label class="block font-medium mb-2">Доставка: Ірпінь/Буча (грн)</label>
          <input id="priceDelIrpin" type="number" min="0" class="w-full focus-ring rounded-2xl px-4 py-3 bg-white/5 border border-white/10" />
        </div>
        <div class="glass rounded-2xl p-4 border border-white/10">
          <label class="block font-medium mb-2">Доставка: Київ (грн)</label>
          <input id="priceDelKyiv" type="number" min="0" class="w-full focus-ring rounded-2xl px-4 py-3 bg-white/5 border border-white/10" />
        </div>
        <div class="glass rounded-2xl p-4 border border-white/10 md:col-span-2">
          <label class="block font-medium mb-2">Доставка: За містом до 30км (грн)</label>
          <input id="priceDelOut" type="number" min="0" class="w-full focus-ring rounded-2xl px-4 py-3 bg-white/5 border border-white/10" />
        </div>
      </div>

      <div class="mt-4 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
        <div class="text-xs opacity-70">
          Порада: ці налаштування зберігаються в <span class="mono">localStorage</span> (тільки на цьому пристрої/браузері).
        </div>
        <div class="flex gap-3">
          <button id="resetPricesBtn" class="btn px-4 py-3 border border-white/10 bg-white/5 hover:bg-white/10">
            Скинути
          </button>
          <button id="savePricesBtn" class="btn px-4 py-3 border border-[rgba(224,90,71,.55)] bg-[rgba(224,90,71,.16)] hover:bg-[rgba(224,90,71,.24)]">
            Зберегти
          </button>
        </div>
      </div>

      <div id="adminMsg" class="hidden mt-3 text-sm rounded-2xl px-4 py-3 border"></div>
    </div>
  </div>

  <script>
    /********************
     * CONFIG / BACKEND
     ********************/
    const APPS_SCRIPT_URL = 'YOUR_URL_HERE'; // <-- встав сюди URL Web App Google Apps Script

    /********************
     * PRICES (editable)
     ********************/
    const DEFAULT_PRICES = {
      laptopPerDay: 1500,
      ps5PerDay: 1200,
      vrPerDay: 1800,
      tvPerDay: 1000,
      adminPerHour: 300,
      delivery: {
        irpin_bucha: 1000,
        kyiv: 1500,
        out_30: 2500
      }
    };

    let PRICES = loadPrices();

    function loadPrices(){
      try{
        const raw = localStorage.getItem('LAIR_PRICES_V1');
        if(!raw) return structuredClone(DEFAULT_PRICES);
        const parsed = JSON.parse(raw);
        // shallow merge with defaults (safety)
        return {
          ...structuredClone(DEFAULT_PRICES),
          ...parsed,
          delivery: { ...structuredClone(DEFAULT_PRICES.delivery), ...(parsed.delivery || {}) }
        };
      }catch(e){
        return structuredClone(DEFAULT_PRICES);
      }
    }
    function savePrices(p){
      localStorage.setItem('LAIR_PRICES_V1', JSON.stringify(p));
    }
    function resetPrices(){
      localStorage.removeItem('LAIR_PRICES_V1');
      PRICES = structuredClone(DEFAULT_PRICES);
    }

    /********************
     * DOM refs
     ********************/
    const tabs = document.querySelectorAll('[data-tab]');
    const panels = {
      equipment: document.getElementById('tab-equipment'),
      logistics: document.getElementById('tab-logistics'),
      contacts: document.getElementById('tab-contacts')
    };

    const el = {
      // sliders
      laptop: document.getElementById('laptop'),
      ps5: document.getElementById('ps5'),
      vr: document.getElementById('vr'),
      tv: document.getElementById('tv'),
      days: document.getElementById('days'),

      // admin
      adminEnabled: document.getElementById('adminEnabled'),
      adminHours: document.getElementById('adminHours'),
      adminHoursBlock: document.getElementById('adminHoursBlock'),

      // delivery
      delivery: document.getElementById('delivery'),

      // qty labels
      qtyLaptop: document.getElementById('qtyLaptop'),
      qtyPS5: document.getElementById('qtyPS5'),
      qtyVR: document.getElementById('qtyVR'),
      qtyTV: document.getElementById('qtyTV'),
      qtyDays: document.getElementById('qtyDays'),
      qtyAdminHours: document.getElementById('qtyAdminHours'),

      // estimate sums
      sumLaptop: document.getElementById('sumLaptop'),
      sumPS5: document.getElementById('sumPS5'),
      sumVR: document.getElementById('sumVR'),
      sumTV: document.getElementById('sumTV'),
      sumDelivery: document.getElementById('sumDelivery'),
      sumAdmin: document.getElementById('sumAdmin'),
      sumTotal: document.getElementById('sumTotal'),

      // pills / badges
      badgeDays: document.getElementById('badgeDays'),
      pillAutoTV: document.getElementById('pillAutoTV'),
      pillAdminMin: document.getElementById('pillAdminMin'),
      pillDelivery: document.getElementById('pillDelivery'),

      // estimate text + copy
      estimateText: document.getElementById('estimateText'),
      copyEstimate: document.getElementById('copyEstimate'),

      // nav buttons
      toLogistics: document.getElementById('toLogistics'),
      toContacts: document.getElementById('toContacts'),
      backToEquipment: document.getElementById('backToEquipment'),
      backToLogistics: document.getElementById('backToLogistics'),

      // form
      orderForm: document.getElementById('orderForm'),
      submitOrder: document.getElementById('submitOrder'),
      formMsg: document.getElementById('formMsg'),
      name: document.getElementById('name'),
      phone: document.getElementById('phone'),
      eventDate: document.getElementById('eventDate'),
      location: document.getElementById('location'),
      comment: document.getElementById('comment'),

      // admin modal
      adminModal: document.getElementById('adminModal'),
      openAdminBtn: document.getElementById('openAdminBtn'),
      closeAdminBtn: document.getElementById('closeAdminBtn'),
      savePricesBtn: document.getElementById('savePricesBtn'),
      resetPricesBtn: document.getElementById('resetPricesBtn'),
      adminMsg: document.getElementById('adminMsg'),

      // admin inputs
      priceLaptop: document.getElementById('priceLaptop'),
      pricePS5: document.getElementById('pricePS5'),
      priceVR: document.getElementById('priceVR'),
      priceTV: document.getElementById('priceTV'),
      priceAdmin: document.getElementById('priceAdmin'),
      priceDelIrpin: document.getElementById('priceDelIrpin'),
      priceDelKyiv: document.getElementById('priceDelKyiv'),
      priceDelOut: document.getElementById('priceDelOut'),
    };

    /********************
     * Utilities
     ********************/
    const fmtUAH = (n) => {
      const v = Math.round(Number(n || 0));
      return v.toLocaleString('uk-UA') + ' грн';
    };

    function setRangeFill(range){
      const min = Number(range.min);
      const max = Number(range.max);
      const val = Number(range.value);
      const pct = ((val - min) / (max - min)) * 100;
      range.style.background = `linear-gradient(90deg, var(--accent) ${pct}%, rgba(255,255,255,.12) ${pct}%)`;
    }

    function showMsg(target, text, type='ok'){
      target.classList.remove('hidden');
      target.textContent = text;
      target.className = target.className.replace(/\bborder-\S+/g,'').replace(/\bbg-\S+/g,'');
      // keep base
      target.classList.add('text-sm','rounded-2xl','px-4','py-3','border');
      if(type === 'ok'){
        target.classList.add('border-emerald-400/30');
        target.style.background = 'rgba(16,185,129,.10)';
        target.style.color = 'rgba(245,245,245,.95)';
      } else if(type === 'warn'){
        target.classList.add('border-amber-400/30');
        target.style.background = 'rgba(245,158,11,.10)';
        target.style.color = 'rgba(245,245,245,.95)';
      } else {
        target.classList.add('border-rose-400/30');
        target.style.background = 'rgba(244,63,94,.10)';
        target.style.color = 'rgba(245,245,245,.95)';
      }
    }

    function hideMsg(target){
      target.classList.add('hidden');
      target.textContent = '';
    }

    /********************
     * Tabs
     ********************/
    function activateTab(name){
      Object.keys(panels).forEach(k => panels[k].classList.toggle('hidden', k !== name));
      tabs.forEach(btn => {
        const isActive = btn.dataset.tab === name;
        btn.classList.toggle('tab-active', isActive);
        btn.classList.toggle('tab-inactive', !isActive);
      });
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    tabs.forEach(btn => btn.addEventListener('click', () => activateTab(btn.dataset.tab)));

    el.toLogistics.addEventListener('click', () => activateTab('logistics'));
    el.toContacts.addEventListener('click', () => activateTab('contacts'));
    el.backToEquipment.addEventListener('click', () => activateTab('equipment'));
    el.backToLogistics.addEventListener('click', () => activateTab('logistics'));

    /********************
     * Constraints
     ********************/
    function enforceTVNotLessThanPS5(){
      const ps5 = Number(el.ps5.value);
      const tv = Number(el.tv.value);
      if(tv < ps5){
        el.tv.value = ps5;
        setRangeFill(el.tv);
      }
      el.pillAutoTV.textContent = `TV ≥ PS5: ${Number(el.tv.value) >= ps5 ? 'OK' : 'FIX'}`;
    }

    function enforceAdminMinHours(){
      if(!el.adminEnabled.checked){
        el.pillAdminMin.textContent = 'Адмін: —';
        return;
      }
      let h = Number(el.adminHours.value);
      if(h < 4){
        h = 4;
        el.adminHours.value = '4';
        setRangeFill(el.adminHours);
      }
      el.pillAdminMin.textContent = `Адмін: ${h} год`;
    }

    /********************
     * State + Calculation
     ********************/
    function getState(){
      const days = Number(el.days.value);

      const items = {
        laptop: Number(el.laptop.value),
        ps5: Number(el.ps5.value),
        vr: Number(el.vr.value),
        tv: Number(el.tv.value),
      };

      const admin = {
        enabled: el.adminEnabled.checked,
        hours: el.adminEnabled.checked ? Math.max(4, Number(el.adminHours.value)) : 0
      };

      const deliveryKey = el.delivery.value;
      const deliveryCost = PRICES.delivery[deliveryKey] ?? 0;

      return { days, items, admin, deliveryKey, deliveryCost };
    }

    function calcTotals(state){
      const d = state.days;

      const sumLaptop = state.items.laptop * PRICES.laptopPerDay * d;
      const sumPS5    = state.items.ps5    * PRICES.ps5PerDay    * d;
      const sumVR     = state.items.vr     * PRICES.vrPerDay     * d;
      const sumTV     = state.items.tv     * PRICES.tvPerDay     * d;

      const sumDelivery = state.deliveryCost; // one-time
      const sumAdmin    = state.admin.enabled ? (state.admin.hours * PRICES.adminPerHour) : 0;

      const subtotal = sumLaptop + sumPS5 + sumVR + sumTV;
      const total = subtotal + sumDelivery + sumAdmin;

      return { sumLaptop, sumPS5, sumVR, sumTV, sumDelivery, sumAdmin, subtotal, total };
    }

    function buildEstimateText(state, totals){
      const deliveryLabel = {
        irpin_bucha: 'Ірпінь / Буча',
        kyiv: 'Київ',
        out_30: 'За містом (до 30км)'
      }[state.deliveryKey] || state.deliveryKey;

      const lines = [];
      lines.push('LAIR — Заявка на оренду (орієнтовний кошторис)');
      lines.push('—'.repeat(48));
      lines.push(`Днів оренди: ${state.days}`);
      lines.push('');
      lines.push('Обладнання:');
      lines.push(`• Ноутбуки (RTX 5070): ${state.items.laptop} шт × ${fmtUAH(PRICES.laptopPerDay)}/доба = ${fmtUAH(totals.sumLaptop)}`);
      lines.push(`• PS5: ${state.items.ps5} шт × ${fmtUAH(PRICES.ps5PerDay)}/доба = ${fmtUAH(totals.sumPS5)}`);
      lines.push(`• VR (Quest 3): ${state.items.vr} шт × ${fmtUAH(PRICES.vrPerDay)}/доба = ${fmtUAH(totals.sumVR)}`);
      lines.push(`• ТВ 50–55" + стійка: ${state.items.tv} шт × ${fmtUAH(PRICES.tvPerDay)}/доба = ${fmtUAH(totals.sumTV)}`);
      lines.push('');
      lines.push(`Доставка: ${deliveryLabel} = ${fmtUAH(totals.sumDelivery)}`);
      lines.push(`Тех. адміністратор: ${state.admin.enabled ? (state.admin.hours + ' год × ' + fmtUAH(PRICES.adminPerHour) + '/год = ' + fmtUAH(totals.sumAdmin)) : 'не потрібно'}`);
      lines.push('—'.repeat(48));
      lines.push(`РАЗОМ: ${fmtUAH(totals.total)}`);
      lines.push('');
      lines.push('* Знижка/лояльність на сайті: 0% (узгоджується менеджером).');

      return lines.join('\n');
    }

    function render(){
      // enforce constraints first
      enforceTVNotLessThanPS5();
      enforceAdminMinHours();

      const state = getState();

      // labels
      el.qtyLaptop.textContent = state.items.laptop;
      el.qtyPS5.textContent = state.items.ps5;
      el.qtyVR.textContent = state.items.vr;
      el.qtyTV.textContent = state.items.tv;
      el.qtyDays.textContent = state.days;
      el.badgeDays.textContent = `× ${state.days}d`;
      if(el.adminEnabled.checked){
        el.qtyAdminHours.textContent = state.admin.hours;
      }

      // delivery pill
      const deliveryLabelShort = {
        irpin_bucha: 'Ірпінь/Буча',
        kyiv: 'Київ',
        out_30: 'до 30км'
      }[state.deliveryKey] || '—';
      el.pillDelivery.textContent = `Доставка: ${deliveryLabelShort}`;

      // totals
      const totals = calcTotals(state);

      el.sumLaptop.textContent = fmtUAH(totals.sumLaptop);
      el.sumPS5.textContent = fmtUAH(totals.sumPS5);
      el.sumVR.textContent = fmtUAH(totals.sumVR);
      el.sumTV.textContent = fmtUAH(totals.sumTV);
      el.sumDelivery.textContent = fmtUAH(totals.sumDelivery);
      el.sumAdmin.textContent = fmtUAH(totals.sumAdmin);
      el.sumTotal.textContent = fmtUAH(totals.total);

      // estimate text
      el.estimateText.textContent = buildEstimateText(state, totals);
    }

    /********************
     * Events (sliders)
     ********************/
    const rangeInputs = [el.laptop, el.ps5, el.vr, el.tv, el.days, el.adminHours];
    rangeInputs.forEach(r => {
      setRangeFill(r);
      r.addEventListener('input', () => {
        setRangeFill(r);
        if(r === el.ps5 || r === el.tv) enforceTVNotLessThanPS5();
        if(r === el.adminHours) enforceAdminMinHours();
        render();
      });
    });

    el.delivery.addEventListener('change', render);

    el.adminEnabled.addEventListener('change', () => {
      el.adminHoursBlock.classList.toggle('hidden', !el.adminEnabled.checked);
      if(el.adminEnabled.checked){
        // ensure minimum 4
        el.adminHours.value = String(Math.max(4, Number(el.adminHours.value || 4)));
        setRangeFill(el.adminHours);
      }
      render();
    });

    // initial
    el.adminHoursBlock.classList.add('hidden');
    render();

    /********************
     * Copy estimate
     ********************/
    el.copyEstimate.addEventListener('click', async () => {
      try{
        await navigator.clipboard.writeText(el.estimateText.textContent);
        showMsg(el.formMsg, 'Кошторис скопійовано в буфер обміну ✅', 'ok');
        setTimeout(()=>hideMsg(el.formMsg), 2500);
      }catch(e){
        showMsg(el.formMsg, 'Не вдалося скопіювати. Спробуй виділити текст вручну.', 'warn');
        setTimeout(()=>hideMsg(el.formMsg), 3500);
      }
    });

    /********************
     * Submit order
     ********************/
    el.orderForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      hideMsg(el.formMsg);

      // validation
      const name = el.name.value.trim();
      const phone = el.phone.value.trim();
      const eventDate = el.eventDate.value;

      if(!name || !phone || !eventDate){
        showMsg(el.formMsg, 'Заповни обовʼязкові поля: Імʼя, Телефон, Дата івенту.', 'warn');
        return;
      }

      // build payload
      const state = getState();
      const totals = calcTotals(state);

      const payload = {
        source: 'LAIR_CALCULATOR',
        createdAt: new Date().toISOString(),
        customer: {
          name,
          phone,
          eventDate,
          location: el.location.value.trim(),
          comment: el.comment.value.trim()
        },
        config: {
          days: state.days,
          items: state.items,
          deliveryZone: state.deliveryKey,
          admin: state.admin
        },
        pricesUsed: PRICES,
        totals: {
          laptop: totals.sumLaptop,
          ps5: totals.sumPS5,
          vr: totals.sumVR,
          tv: totals.sumTV,
          delivery: totals.sumDelivery,
          admin: totals.sumAdmin,
          total: totals.total
        },
        estimateText: el.estimateText.textContent,
        discountPercent: 0
      };

      // UI lock
      el.submitOrder.disabled = true;
      el.submitOrder.style.opacity = '0.75';

      try{
        if(!APPS_SCRIPT_URL || APPS_SCRIPT_URL === 'YOUR_URL_HERE'){
          throw new Error('APPS_SCRIPT_URL not set');
        }

        const res = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          mode: 'cors'
        });

        // many GAS apps return text; be tolerant
        const text = await res.text();
        if(!res.ok){
          throw new Error(text || 'Request failed');
        }

        showMsg(el.formMsg, 'Заявку відправлено ✅ Ми звʼяжемось з тобою найближчим часом.', 'ok');
        // optional: reset contact fields only
        // el.orderForm.reset();

      }catch(err){
        const msg = (String(err && err.message || err)).includes('APPS_SCRIPT_URL not set')
          ? 'Помилка: не задано APPS_SCRIPT_URL. Встав URL вашого Google Apps Script Web App.'
          : 'Не вдалося відправити заявку ❌ Перевір інтернет/URL Web App або CORS налаштування.';
        showMsg(el.formMsg, msg, 'err');
      }finally{
        el.submitOrder.disabled = false;
        el.submitOrder.style.opacity = '1';
      }
    });

    /********************
     * Admin mode
     ********************/
    function openAdmin(){
      // populate inputs
      el.priceLaptop.value = PRICES.laptopPerDay;
      el.pricePS5.value = PRICES.ps5PerDay;
      el.priceVR.value = PRICES.vrPerDay;
      el.priceTV.value = PRICES.tvPerDay;
      el.priceAdmin.value = PRICES.adminPerHour;
      el.priceDelIrpin.value = PRICES.delivery.irpin_bucha;
      el.priceDelKyiv.value = PRICES.delivery.kyiv;
      el.priceDelOut.value = PRICES.delivery.out_30;

      hideMsg(el.adminMsg);
      el.adminModal.classList.remove('hidden');
      el.adminModal.classList.add('flex');
    }
    function closeAdmin(){
      el.adminModal.classList.add('hidden');
      el.adminModal.classList.remove('flex');
    }

    el.openAdminBtn.addEventListener('click', openAdmin);
    el.closeAdminBtn.addEventListener('click', closeAdmin);
    el.adminModal.addEventListener('click', (e) => {
      if(e.target === el.adminModal) closeAdmin();
    });
    window.addEventListener('keydown', (e) => {
      if(e.key === 'Escape' && !el.adminModal.classList.contains('hidden')) closeAdmin();
    });

    el.savePricesBtn.addEventListener('click', () => {
      const next = structuredClone(PRICES);
      const n = (x) => Math.max(0, Number(x || 0));

      next.laptopPerDay = n(el.priceLaptop.value);
      next.ps5PerDay = n(el.pricePS5.value);
      next.vrPerDay = n(el.priceVR.value);
      next.tvPerDay = n(el.priceTV.value);
      next.adminPerHour = n(el.priceAdmin.value);

      next.delivery = {
        irpin_bucha: n(el.priceDelIrpin.value),
        kyiv: n(el.priceDelKyiv.value),
        out_30: n(el.priceDelOut.value)
      };

      PRICES = next;
      savePrices(PRICES);
      showMsg(el.adminMsg, 'Збережено ✅ Ціни оновлено.', 'ok');
      render();
    });

    el.resetPricesBtn.addEventListener('click', () => {
      resetPrices();
      showMsg(el.adminMsg, 'Скинуто до стандартних значень ✅', 'ok');
      openAdmin(); // repopulate with defaults
      render();
    });

    /********************
     * Minor UX: keep slider fill updated on resize / load
     ********************/
    window.addEventListener('load', () => rangeInputs.forEach(setRangeFill));
  </script>
</body>
</html>
