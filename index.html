<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LAIR Mobile Event</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Arial;max-width:980px;margin:24px auto;padding:0 12px}
    h2{margin:0 0 8px}
    .muted{color:#666;font-size:14px;line-height:1.4}
    .card{border:1px solid #ddd;border-radius:14px;padding:14px;margin:12px 0}
    label{display:block;margin:10px 0 6px;font-weight:600}
    input,select,textarea{
      width:100%;padding:10px 12px;border:1px solid #ccc;border-radius:12px;
      outline:none
    }
    input:focus,select:focus,textarea:focus{border-color:#111}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .gridItems{display:grid;grid-template-columns:1fr 140px;gap:10px;align-items:center;margin:8px 0}
    .btn{cursor:pointer;border:0;border-radius:12px;padding:12px 14px;font-weight:700}
    .btnPrimary{background:#111;color:#fff}
    .btnGhost{background:#f3f3f3}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#f3f3f3;font-size:12px;margin:6px 6px 0 0}
    .err{color:#b00020;font-weight:700}
    .ok{color:#0a7a2f;font-weight:700}
    .total{font-size:20px;font-weight:800;margin-top:8px}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .kpi .box{border:1px dashed #ccc;border-radius:14px;padding:10px}
    .hint{font-size:12px;color:#666;margin-top:6px}
    .divider{height:1px;background:#eee;margin:12px 0}
    .disabled{opacity:.55;pointer-events:none}
  </style>
</head>
<body>
  <h2>LAIR Mobile Event — калькулятор</h2>
  <div class="muted">
    Рахує вартість, передплату <b>30%</b>, заставу та записує заявку в Google Sheet.
    Мінімум <b>4 години</b> для погодинної оренди. Склад зараз: <b>по 2 одиниці</b> кожного девайса.
  </div>

  <div class="card">
    <div class="row">
      <div>
        <label>Ім'я</label>
        <input id="name" placeholder="Микита" />
      </div>
      <div>
        <label>Телефон</label>
        <input id="phone" placeholder="+380XXXXXXXXX або 0XXXXXXXXX" />
        <div class="hint">Формат: +380XXXXXXXXX або 0XXXXXXXXX</div>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Місто/зона</label>
        <select id="cityZone">
          <option value="irpin">Ірпінь</option>
          <option value="bucha">Буча</option>
          <option value="kyiv">Київ</option>
        </select>
      </div>
      <div>
        <label>Адреса (коротко)</label>
        <input id="address" placeholder="вул..., ЖК..., під'їзд..." />
      </div>
    </div>

    <div class="row3">
      <div>
        <label>Дата/час старту</label>
        <input id="dateStart" placeholder="YYYY-MM-DD HH:MM (напр. 2026-02-10 18:00)" />
        <div class="hint">Нічний тариф: 22:00–08:00</div>
      </div>
      <div>
        <label>Терміновість</label>
        <select id="sameDay">
          <option value="false">Заплановано &gt; 24 год</option>
          <option value="true">День-в-день (2–4 год)</option>
        </select>
      </div>
      <div>
        <label>Тип оренди</label>
        <select id="rentType">
          <option value="hour">Погодинна</option>
          <option value="day">Подобова</option>
        </select>
      </div>
    </div>

    <div class="row3">
      <div>
        <label>Тривалість (годин або діб)</label>
        <input id="duration" type="number" min="1" value="4" />
      </div>
      <div>
        <label>Нагляд (впливає на заставу)</label>
        <select id="supervision">
          <option value="admin">Адміністратор весь час</option>
          <option value="cam">IP-камера весь час</option>
          <option value="none">Без нагляду</option>
        </select>
      </div>
      <div>
        <label>Адміністратори</label>
        <select id="adminCount">
          <option value="1">1 адмін (включено)</option>
          <option value="2">2 адміни (доплата)</option>
        </select>
        <div class="hint">Доступно одночасно: 2</div>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Реферальний код (опціонально)</label>
        <input id="referralCode" placeholder="C2E123" />
      </div>
      <div>
        <label>Рівень лояльності</label>
        <select id="loyaltyLevel">
          <option value="bronze">Bronze</option>
          <option value="silver">Silver (–5% на погодинну)</option>
          <option value="gold">Gold (–8% на погодинну)</option>
          <option value="platinum">Platinum (–12% на погодинну)</option>
        </select>
      </div>
    </div>

    <div style="margin-top:8px">
      <label style="font-weight:700">
        <input id="locationEnabled" type="checkbox" />
        + Локація (середня доба по зоні + 25%)
      </label>
      <div class="hint">Ірпінь/Буча: 1500 → 1875 ₴/доба (≈117 ₴/год) • Київ: 2000 → 2500 ₴/доба (≈156 ₴/год)</div>
    </div>

    <div class="divider"></div>

    <div class="row">
      <div>
        <label>Пакет (вигідніше)</label>
        <select id="packageKey" onchange="onPackageChange()">
          <option value="">Без пакету</option>
          <option value="lan5">LAN 5</option>
          <option value="lan10">LAN 10</option>
          <option value="ps5duo">PS5 Duo</option>
          <option value="ps5x4">PS5 x4</option>
          <option value="vr2">VR x2</option>
        </select>
        <div class="hint">Увага: при складі “по 2” пакети LAN 5/10 не пройдуть перевірку.</div>
      </div>
      <div>
        <label>Коментар</label>
        <input id="notes" placeholder="Ігри, побажання, поверх, ліфт, паркінг..." />
      </div>
    </div>

    <div style="margin-top:8px">
      <span class="pill">Доставка: Ірпінь/Буча ×1.00 • Київ ×1.15</span>
      <span class="pill">Терміновість день-в-день ×1.20</span>
      <span class="pill">Нічний тариф ×1.15</span>
      <span class="pill">Передплата 30%</span>
    </div>
  </div>

  <div class="card" id="itemsCard">
    <h3 style="margin:0 0 6px">Позиції (якщо без пакету)</h3>
    <div class="muted">Ліміт складу: максимум <b>2</b> кожного. Якщо обрано пакет — ці поля ігноруються.</div>

    <div class="gridItems"><div>Ноутбук RTX 5070</div><input id="laptop5070" type="number" min="0" value="0" oninput="enforceLimit(this)"></div>
    <div class="gridItems"><div>PS5</div><input id="ps5" type="number" min="0" value="0" oninput="enforceLimit(this)"></div>
    <div class="gridItems"><div>TV 50"</div><input id="tv50" type="number" min="0" value="0" oninput="enforceLimit(this)"></div>
    <div class="gridItems"><div>Монітор</div><input id="monitor" type="number" min="0" value="0" oninput="enforceLimit(this)"></div>
    <div class="gridItems"><div>Стіл ігровий</div><input id="table" type="number" min="0" value="0" oninput="enforceLimit(this)"></div>
    <div class="gridItems"><div>Крісло ігрове</div><input id="chair" type="number" min="0" value="0" oninput="enforceLimit(this)"></div>
    <div class="gridItems"><div>ДБЖ</div><input id="ups" type="number" min="0" value="0" oninput="enforceLimit(this)"></div>
    <div class="gridItems"><div>VR</div><input id="vr" type="number" min="0" value="0" oninput="enforceLimit(this)"></div>

    <label style="margin-top:12px">
      <input id="adminExtra" type="checkbox">
      Додати адмін-супровід для “дрібного” замовлення (опція)
    </label>
  </div>

  <div class="card">
    <button class="btn btnGhost" onclick="validateOnly()">Перевірити дані</button>
    <button class="btn btnPrimary" onclick="submit()">Оформити замовлення</button>
    <div id="msg" class="muted" style="margin-top:12px"></div>
  </div>

<script>
  const STOCK_LIMIT = 2;

  function $(id){ return document.getElementById(id); }
  function val(id){ return $(id).value; }
  function num(id){ return Number($(id).value || 0); }

  function setMsg(html, cls="muted"){
    const el = $("msg");
    el.className = cls;
    el.innerHTML = html;
  }

  function enforceLimit(input){
    const n = Number(input.value || 0);
    if (n > STOCK_LIMIT) input.value = STOCK_LIMIT;
    if (n < 0) input.value = 0;
  }

  function onPackageChange(){
    const hasPackage = !!val("packageKey");
    const card = $("itemsCard");
    if (hasPackage) card.classList.add("disabled");
    else card.classList.remove("disabled");
  }

  function isValidPhoneUA(phone){
    const p = String(phone || "").replace(/\s+/g,"");
    return /^(\+380\d{9}|0\d{9})$/.test(p);
  }

  function clientValidate(p){
    const name = (p.name||"").trim();
    if(name.length < 2) return "Вкажи ім'я (мін 2 символи).";

    if(!isValidPhoneUA(p.phone)) return "Невірний телефон. Формат: +380XXXXXXXXX або 0XXXXXXXXX.";

    const dur = Number(p.duration);
    if(!Number.isFinite(dur) || dur <= 0) return "Невірна тривалість.";

    if(p.rentType === "hour" && dur < 4) return "Мінімум 4 години для погодинної оренди.";

    const adminCount = Number(p.adminCount);
    if(![1,2].includes(adminCount)) return "Адміністратори: обери 1 або 2.";

    // складські ліміти
    const keys = ["laptop5070","ps5","tv50","monitor","table","chair","ups","vr"];
    for(const k of keys){
      if (p.items[k] > STOCK_LIMIT) return `Перевищено ліміт складу для ${k}: максимум ${STOCK_LIMIT}.`;
      if (p.items[k] < 0) return `Кількість не може бути від'ємною (${k}).`;
    }

    // має бути хоча б 1 позиція або пакет
    const hasPackage = !!p.packageKey;
    const totalQty = Object.values(p.items).reduce((a,b)=>a+Number(b||0),0);
    if(!hasPackage && totalQty <= 0) return "Додай хоча б 1 позицію або обери пакет.";

    return null;
  }

  function buildPayload(){
    return {
      name: val("name"),
      phone: val("phone"),
      cityZone: val("cityZone"),
      address: val("address"),
      dateStart: val("dateStart"),
      rentType: val("rentType"),
      duration: val("duration"),
      sameDay: (val("sameDay") === "true"),
      supervision: val("supervision"),
      adminCount: Number(val("adminCount")),
      referralCode: val("referralCode"),
      loyaltyLevel: val("loyaltyLevel"),
      locationEnabled: $("locationEnabled").checked,
      packageKey: val("packageKey"),
      adminExtra: $("adminExtra").checked,
      notes: val("notes"),
      items: {
        laptop5070: num("laptop5070"),
        ps5: num("ps5"),
        tv50: num("tv50"),
        monitor: num("monitor"),
        table: num("table"),
        chair: num("chair"),
        ups: num("ups"),
        vr: num("vr")
      }
    };
  }

  function validateOnly(){
    const p = buildPayload();
    const err = clientValidate(p);
    if(err) return setMsg(err, "err");

    const hasPackage = !!p.packageKey;
    setMsg(
      `<div class="ok">Дані валідні ✅</div>
       <div class="muted">Можеш натискати «Оформити замовлення».</div>
       <div class="hint">${hasPackage ? "Обрано пакет — ручні позиції ігноруються." : "Розрахунок буде по вибраних позиціях."}</div>`,
      "ok"
    );
  }

  function submit(){
    const p = buildPayload();
    const err = clientValidate(p);
    if(err) return setMsg(err, "err");

    setMsg("Відправляю заявку...", "muted");
    google.script.run
      .withSuccessHandler(res => {
        const b = res.breakdown || {};
        setMsg(
          `<div class="ok"><b>Готово!</b> Заявка № <b>${res.orderId}</b></div>
           <div class="total">Всього: ${b.total} ₴</div>
           <div class="kpi">
             <div class="box"><div class="muted">Передплата 30%</div><div><b>${b.prepay30} ₴</b></div></div>
             <div class="box"><div class="muted">Досплата</div><div><b>${b.restToPay} ₴</b></div></div>
           </div>
           <div class="divider"></div>
           <div class="muted">Застава: <b>${b.deposit} ₴</b> (оцінка обладнання: ${b.equipValue} ₴)</div>
           <div class="muted">Коефіцієнти: зона ${b.zoneCoef} • терміновість ${b.urgencyCoef} • нічний ${b.nightCoef}</div>
           <div class="muted">+Локація: ${b.locationPrice ? (b.locationPrice + " ₴") : "ні"}</div>`,
          "ok"
        );
      })
      .withFailureHandler(e => setMsg(e.message || String(e), "err"))
      .submitOrder(p);
  }

  // init
  onPackageChange();
</script>
</body>
</html>
